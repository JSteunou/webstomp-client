!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.webstomp=t():e.webstomp=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),a=r(i),o=n(1),s={VERSIONS:o.VERSIONS,client:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{protocols:o.VERSIONS.supportedProtocols()},n=new WebSocket(e,t.protocols);return new a.default(n,t)},over:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return new(Function.prototype.bind.apply(a.default,[null].concat(t)))}};t.default=s,e.exports=t.default},function(e,t){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function r(e){var t=encodeURIComponent(e),n=t.replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),r=Array.prototype.map.call(n,function(e){return e.charCodeAt(0)});return new Uint8Array(r)}function i(e){var t=String.fromCharCode.apply(String,n(e)),r=t.replace(/(.)/g,function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n});return decodeURIComponent(r)}function a(e){return e?encodeURIComponent(e).match(/%..|./g).length:0}Object.defineProperty(t,"__esModule",{value:!0}),t.unicodeStringToTypedArray=r,t.typedArrayToUnicodeString=i,t.sizeOfUTF8=a;t.VERSIONS={V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.2,1.1,1.0"},supportedProtocols:function(){return["v10.stomp","v11.stomp","v12.stomp"]}},t.BYTES={LF:"\n",NULL:"\0"},t.trim=function(e){return e.replace(/^\s+|\s+$/g,"")}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(3),s=r(o),u=n(1),c=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e);var r=n.binary,a=void 0!==r&&r,o=n.heartbeat,s=void 0===o?{outgoing:1e4,incoming:1e4}:o,u=n.debug,c=void 0===u||u;this.ws=t,this.ws.binaryType="arraybuffer",this.isBinary=!!a,this.hasDebug=!!c,this.counter=0,this.connected=!1,this.heartbeat=s||{outgoing:0,incoming:0},this.maxWebSocketFrameSize=16384,this.subscriptions={},this.partialData=""}return a(e,[{key:"debug",value:function(){var e;this.hasDebug&&(e=console).log.apply(e,arguments)}},{key:"connect",value:function(){var e=this,t=this._parseConnect.apply(this,arguments),n=t[0],r=t[1],i=t[2];this.connectCallback=r,this.debug("Opening Web Socket..."),this.ws.onmessage=function(t){var n=t.data;if(t.data instanceof ArrayBuffer&&(n=(0,u.typedArrayToUnicodeString)(new Uint8Array(t.data))),e.serverActivity=Date.now(),n===u.BYTES.LF)return void e.debug("<<< PONG");e.debug("<<< "+n);var a=s.default.unmarshall(e.partialData+n);e.partialData=a.partial,a.frames.forEach(function(t){switch(t.command){case"CONNECTED":e.debug("connected to server "+t.headers.server),e.connected=!0,e.version=t.headers.version,e._setupHeartbeat(t.headers),r&&r(t);break;case"MESSAGE":var n=t.headers.subscription,a=e.subscriptions[n]||e.onreceive;if(a){var o=e.version===u.VERSIONS.V1_2&&t.headers.ack||t.headers["message-id"];t.ack=e.ack.bind(e,o,n),t.nack=e.nack.bind(e,o,n),a(t)}else e.debug("Unhandled received MESSAGE: "+t);break;case"RECEIPT":e.onreceipt&&e.onreceipt(t);break;case"ERROR":i&&i(t);break;default:e.debug("Unhandled frame: "+t)}})},this.ws.onclose=function(t){e.debug("Whoops! Lost connection to "+e.ws.url+":",t),e._cleanUp(),i&&i(t)},this.ws.onopen=function(){e.debug("Web Socket Opened..."),n["accept-version"]=u.VERSIONS.supportedVersions(),n["heart-beat"]||(n["heart-beat"]=[e.heartbeat.outgoing,e.heartbeat.incoming].join(",")),e._transmit("CONNECT",n)}}},{key:"disconnect",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._transmit("DISCONNECT",t),this.ws.onclose=null,this.ws.close(),this._cleanUp(),e&&e()}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.destination=e,this._transmit("SEND",n,t)}},{key:"begin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"tx-"+this.counter++;return this._transmit("BEGIN",{transaction:e}),{id:e,commit:this.commit.bind(this,e),abort:this.abort.bind(this,e)}}},{key:"commit",value:function(e){this._transmit("COMMIT",{transaction:e})}},{key:"abort",value:function(e){this._transmit("ABORT",{transaction:e})}},{key:"ack",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.version===u.VERSIONS.V1_2?"id":"message-id";n[r]=e,n.subscription=t,this._transmit("ACK",n)}},{key:"nack",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.version===u.VERSIONS.V1_2?"id":"message-id";n[r]=e,n.subscription=t,this._transmit("NACK",n)}},{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.id||(n.id="sub-"+this.counter++),n.destination=e,this.subscriptions[n.id]=t,this._transmit("SUBSCRIBE",n),{id:n.id,unsubscribe:this.unsubscribe.bind(this,n.id)}}},{key:"unsubscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};delete this.subscriptions[e],t.id=e,this._transmit("UNSUBSCRIBE",t)}},{key:"_cleanUp",value:function(){this.connected=!1,clearInterval(this.pinger),clearInterval(this.ponger)}},{key:"_transmit",value:function(e,t,n){var r=s.default.marshall(e,t,n);this.debug(">>> "+r),this._wsSend(r)}},{key:"_wsSend",value:function(e){for(this.isBinary&&(e=(0,u.unicodeStringToTypedArray)(e)),this.debug(">>> length "+e.length);;){if(!(e.length>this.maxWebSocketFrameSize))return this.ws.send(e);this.ws.send(e.slice(0,this.maxWebSocketFrameSize)),e=e.slice(this.maxWebSocketFrameSize),this.debug("remaining = "+e.length)}}},{key:"_setupHeartbeat",value:function(e){var t=this;if(this.version===u.VERSIONS.V1_1||this.version===u.VERSIONS.V1_2){var n=(e["heart-beat"]||"0,0").split(",").map(function(e){return parseInt(e,10)}),r=n[0],i=n[1];if(0!==this.heartbeat.outgoing&&0!==i){var a=Math.max(this.heartbeat.outgoing,i);this.debug("send PING every "+a+"ms"),this.pinger=setInterval(function(){t._wsSend(u.BYTES.LF),t.debug(">>> PING")},a)}0!==this.heartbeat.incoming&&0!==r&&!function(){var e=Math.max(t.heartbeat.incoming,r);t.debug("check PONG every "+e+"ms"),t.ponger=setInterval(function(){var n=Date.now()-t.serverActivity;n>2*e&&(t.debug("did not receive server activity for the last "+n+"ms"),t.ws.close())},e)}()}}},{key:"_parseConnect",value:function(){for(var e={},t=void 0,n=void 0,r=arguments.length,i=Array(r),a=0;a<r;a++)i[a]=arguments[a];switch(i.length){case 2:e=i[0],t=i[1];break;case 3:i[1]instanceof Function?(e=i[0],t=i[1],n=i[2]):(e.login=i[0],e.passcode=i[1],t=i[2]);break;case 4:e.login=i[0],e.passcode=i[1],t=i[2],n=i[3];break;default:e.login=i[0],e.passcode=i[1],t=i[2],n=i[3],e.host=i[4]}return[e,t,n]}}]),e}();t.default=c,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(1),o=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";r(this,e),this.command=t,this.headers=n,this.body=i}return i(e,[{key:"toString",value:function(){var e=this,t=[this.command],n=this.headers["content-length"]===!1;return n&&delete this.headers["content-length"],Object.keys(this.headers).forEach(function(n){var r=e.headers[n];t.push(n+":"+r)}),this.body&&!n&&t.push("content-length:"+(0,a.sizeOfUTF8)(this.body)),t.push(a.BYTES.LF+this.body),t.join(a.BYTES.LF)}}],[{key:"unmarshallSingle",value:function(t){var n=t.search(new RegExp(a.BYTES.LF+a.BYTES.LF)),r=t.substring(0,n).split(a.BYTES.LF),i=r.shift(),o={},s="",u=n+2;for(var c in r.reverse()){var l=c.indexOf(":");o[(0,a.trim)(c.substring(0,l))]=(0,a.trim)(c.substring(l+1))}if(o["content-length"]){var h=parseInt(o["content-length"],10);s=(""+t).substring(u,u+h)}else for(var d=null,f=u;f<t.length&&(d=t.charAt(f),d!==a.BYTES.NULL);f++)s+=d;return new e(i,o,s)}},{key:"unmarshall",value:function(t){var n=t.split(new RegExp(a.BYTES.NULL+a.BYTES.LF+"*")),r=n.slice(0,-1),i=n.slice(-1)[0],o={frames:r.map(function(t){return e.unmarshallSingle(t)}),partial:""};return i===a.BYTES.LF||i.search(RegExp(a.BYTES.NULL+a.BYTES.LF+"*$"))!==-1?o.frames.push(e.unmarshallSingle(i)):o.partial=i,o}},{key:"marshall",value:function(t,n,r){var i=new e(t,n,r);return i.toString()+a.BYTES.NULL}}]),e}();t.default=o,e.exports=t.default}])});